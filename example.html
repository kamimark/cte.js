<!DOCTYPE html>
<html>
<head>
  <script src="cte.debug.js"></script>
  <style>
    .hidden {
      display: none;
    }
    [cte] {
      display: none;
    }
  </style>
</head>
<body>
  <li cte="friend-item">
    <span data="name"></span>&nbsp;<span data="age"></span>
  </li>
  <!-- INVALID li cte="nicknames-item"><span data="$it"></span></li-->
  <div cte="person-template">
    <select data="title">
      <option value="mr">Mr</option>
      <option value="mrs">Mrs</option>
      <option value="miss">Miss</option>
    </select>
    <span data="name"></span>
    <br/>
    <label>Age:</label><span data="age" data-type="number"></span>
    <br/>
    <input type="number" data="money" placeholder="money"></input>
    <br/>
    <input type="range" data="age" placeholder="age"></input>
    <br/>
    <label>Has license:</label><input type="checkbox" data="has_license"></input>
    <br/>
    <ul data="friends" cte-ref="friend-item"></ul>
    <ul data="nicknames">
      <li><b><span data="$it"></span></b></li>
    </ul>
    <ul data="array2d">
      <li>
        <ul data="$it">
          <li><b><span data="$it"></span></b></li>
        </ul>
      </li>
    </ul>
  </div>

  <div cte="basic">
    <h1 data="title"></h1>
    <h2 data="subtitle"></h2>
    <input type="text" data="content.field1" placeholder="field1"></input>
    <input type="text" data="content.field2" placeholder="field2"></input>
    <div cte-ref="person-template" data="person"></div>
    <button id="getObj">Get</button>
    <button id="setObj">Set</button>
  </div>

  <button id="add">Add Single template</button>
  <button id="addMulti">Add Multiple templates</button>
  <button id="show" class="hidden">Show template</button>
  <button id="hide" class="hidden">Hide template</button>

  <div class="container"></div>

  
  <div id="test-container">
    <div cte="referenced-test">
      <div id="key" data="key"></div>
    </div>
    <div cte="ref-array-object-test">
      <span id="x" data="x"></span>
    </div>

    <div cte="test">
      <div id="basic-test" data="basic"></div>
      <div id="referenced-test" cte-ref="referenced-test" data="referenced"></div>
      <div id="object-test"><span id="x" data="object.x"></span><span id="y" data="object.y"></span></div>

      <div id="array-object-test" data="arrayObject"><span data="$it.x"></span></div>
      <div cte-ref="ref-array-object-test" id="ref-array-object-test" data="arrayObject"></div>

      <ul id="simple-array-test" data="array"><li data="$it" title="From Array"></li></ul>
      <ul id="nested-array-test" data="array2d"><li data="$it"><ul><li data="$it" title="From 2D array"></li></ul></li></ul>

      <input id="input-checkbox-test" type="checkbox" data="input.checkbox"></input><br/>
      <input id="input-number-test" type="number" data="input.number" title="Number only"></input><br/>
      <input id="input-text-test" type="text" data="input.text" title="Text"></input><br/>
      <input id="input-range-test" type="range" data="input.range" trans="html-object" title="Range as object"></input><br/>
      <input id="input-range-attr-test" type="range" data="input.rangeAttr" trans="attr-object" title="Range using attrs"></input>
      <input id="input-range-value-test" type="range" data="input.rangeValue" title="Range using value" min="0" max="10" defaultValue="3"></input>

      <a id="simple-a-test" data="aRaw" title="Passed as string"></a><br/>
      <a id="simple-a-static-name-test" data="aRaw" title="With static name">Here</a><br/>
      <a id="a-test" data="a" trans="html-object" title="Passed as object"></a><br/>

      <select id="select-test" data="select">
        <option value="s1">Not Selected</option>
        <option value="s2">Selected</option>
        <option value="s3">Not Selected</option>
      </select>

      <div visibility="hideme" style="color:red;">
        <label >Failed test case</label><span><b data="hideme"></b></span>
      </div>
    </div>
  </div>
  <script>
    function runTests() {
      function report(text, passed) {
        if (!passed)
          alert(`Failed Test - ${text}`);
      }

      const testObject = {
        basic: "Basic",
        referenced: { key: "Value" },
        object: {x:1, y:2},
        arrayObject: [{x:3}, {x:4}],
        array: [10, 20],
        array2d: [[100, 200], [300, 400]],
        input: {
          checkbox: true,
          number: 5,
          text: "Text",
          range: {min: 0, max: 10, defaultValue: 3, value: undefined},
          rangeAttr: {min: 0, max: 10, defaultValue: 3, value: 4},
          rangeValue: 6
        },
        select: 's2',
        aRaw: 'http://www.google.com/',
        a: {
          href: 'http://www.google.com/',
          innerHTML: 'Google'
        },
      };

      try
      {
        const template = cte.newDom('test', '#test-container', testObject);

        report('Basic', template.querySelector('#basic-test').innerHTML == testObject.basic);
        report('Referenced', template.querySelector('#referenced-test #key').innerHTML == testObject.referenced.key);
        report('Simple Object',
          template.querySelector('#object-test #x').innerHTML == testObject.object.x &&
          template.querySelector('#object-test #y').innerHTML == testObject.object.y);
        report('Array Object',
          template.querySelector('#array-object-test span:first-child').innerHTML == testObject.arrayObject[0].x &&
          template.querySelector('#array-object-test span:last-child').innerHTML == testObject.arrayObject[1].x);
        report('Ref Array Object',
          template.querySelectorAll('#ref-array-object-test span').item(0).innerHTML == testObject.arrayObject[0].x &&
          template.querySelectorAll('#ref-array-object-test span').item(1).innerHTML == testObject.arrayObject[1].x);

        report('Array',
          template.querySelector('#simple-array-test li:first-child').innerHTML == testObject.array[0] &&
          template.querySelector('#simple-array-test li:last-child').innerHTML == testObject.array[1]);

        report('Array2D',
          template.querySelectorAll('#nested-array-test > li:first-child li').item(0).innerHTML == testObject.array2d[0][0] &&
          template.querySelectorAll('#nested-array-test > li:first-child li').item(1).innerHTML == testObject.array2d[0][1] && 
          template.querySelectorAll('#nested-array-test > li:last-child li').item(0).innerHTML == testObject.array2d[1][0] &&
          template.querySelectorAll('#nested-array-test > li:last-child li').item(1).innerHTML == testObject.array2d[1][1]);

        report('Input.Checkbox', template.querySelector('#input-checkbox-test').checked == testObject.input.checkbox);
        report('Input.Number', template.querySelector('#input-number-test').value == testObject.input.number);
        report('Input.Text', template.querySelector('#input-text-test').value == testObject.input.text);
        report('Input.Range', template.querySelector('#input-range-test').value == testObject.input.range.defaultValue);
        report('Input.Range.Value', template.querySelector('#input-range-value-test').value == testObject.input.rangeValue);

        const simpleATest = template.querySelector('#simple-a-test');
        report('Simple Link', simpleATest.innerHTML == simpleATest.href && simpleATest.href == testObject.aRaw);
        const linkTest = template.querySelector('#a-test');
        report('Link', linkTest.innerHTML == testObject.a.innerHTML && linkTest.href == testObject.a.href);
        const staticLinkTest = template.querySelector('#simple-a-static-name-test');
        report('Static Link', staticLinkTest.innerHTML != staticLinkTest.href && linkTest.href == testObject.aRaw);
        report('Select', template.querySelector('#select-test').value == testObject.select);
        
        const returned = cte.getObject(template);

        report('GetObject.Basic', testObject.basic == returned.basic);
        report('GetObject.Referenced', testObject.referenced.key == returned.referenced.key);
        report('GetObject.SimpleObject', testObject.object.x == returned.object.x && testObject.object.y == returned.object.y);
        report('GetObject.ArrayObject', testObject.arrayObject[0].x == returned.arrayObject[0].x && testObject.arrayObject[1].x == returned.arrayObject[1].x);
        report('GetObject.Array', testObject.array[0] == returned.array[0] && testObject.array[1] == returned.array[1]);
        report('GetObject.Array2D', testObject.array2d[0][0] == returned.array2d[0][0] && testObject.array2d[1][1] == returned.array2d[1][1]);
        report('GetObject.Input.Checkbox', testObject.input.checkbox === returned.input.checkbox);
        report('GetObject.Input.Number', testObject.input.number === returned.input.number);
        report('GetObject.Input.Text', testObject.input.text === returned.input.text);
        report('GetObject.Input.Range', testObject.input.range.defaultValue == returned.input.range.value);
        report('GetObject.Input.RangeAttr', testObject.input.rangeAttr.value == returned.input.rangeAttr.value);
        report('GetObject.Input.RangeValue', testObject.input.rangeValue == returned.input.rangeValue);
      } catch (e) {
        report('Thrown Exception', false);
        console.error(e)
      }

    }
  
    cte.$global.age_range = {min: 2, max: 10, step: 1};
    let object = {
      title: 'title',
      subtitle: 'subtitle',
      content: {'field1': 'Content1', 'field2': 'Content2'},
      person: {
        title: 'mr',
        name: 'Markos',
        age: 5,
        has_license: true,
        nicknames: ['Power Ranger', 'Captain Planet'],
        friends: [{name: 'John Doe', age:'Unknown'}, {name: 'Jean Doe', age:'25'}],
        array2d: [[1,2,3],[1,2,3],[1,2,3]]
      }
    };

    let object2 = {
      title: 'title2',
      subtitle: 'subtitle2',
      content: {'field1': 'Content12', 'field2': 'Content22'},
      person: {
        title: 'mr',
        name: 'Markos2',
        age: 5,
        has_license: true,
        nicknames: ['Power Ranger2', 'Captain Planet2'],
        friends: [{name: 'John Doe2', age:'Unknown2'}, {name: 'Jean Doe2', age:'25'}],
      }
    };

    const multiObjects = [object, object2];

    document
      .querySelector('#add')
      .addEventListener('click', (e) => {
        const template = cte.newDom('basic', '.container', object);
        template
          .querySelector('#getObj')
          .addEventListener('click', (e) => {
            const object = cte.getObject(template);
            console.log(object);
            alert(JSON.stringify(object));
        });

        template
          .querySelector('#setObj')
          .addEventListener('click', (e) => {
            object = cte.getObject(template);
        });
    });

    document
      .querySelector('#addMulti')
      .addEventListener('click', (e) => {
        const templates = cte.newDom('basic', '.container', multiObjects);
        for (const template of templates)
          for (const button of template.querySelectorAll('button'))
            button.parentNode.removeChild(button); 
    });

    function ready(fn) {
      if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading"){
        fn();
      } else {
        document.addEventListener('DOMContentLoaded', fn);
      }    
    }

    ready(runTests);
  </script>
</body>
</html>
